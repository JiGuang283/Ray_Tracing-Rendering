# <div align="center">技术说明文档

## 项目文件与符号索引

### 源文件列表

* `src/app/Application.cpp` / `.h`
* `src/app/WindowsApp.h` / `.cpp`
* `src/app/RenderManager.h` / `.cpp`
* `src/app/ImageProcessor.h` / `.cpp`
* `src/app/PerformanceMonitor.h` / `.cpp`
* `src/utils/image_ops.h` / `.cpp`
* `src/utils/simd.h`
* `src/utils/aligned_allocator.h`

### 核心模块类

* **`WindowsApp`**: 窗口管理与后端封装
* **`Application`**: 应用程序主逻辑与 UI 控制
* **`RenderManager`**: 渲染线程与状态管理
* **`ImageProcessor`**: 图像后处理与色调映射
* **`PerformanceMonitor`**: 性能指标统计

---

## 概览

* **类型**: 基于 SDL2 + ImGui 的实时 GUI 光线追踪渲染器。采用 CPU 渲染，支持实时 UI 调参与图像后处理。
* **渲染框架**:
  * 渲染线程将场景采样结果写入 `RenderBuffer`（浮点 RGB）。
  * 应用层调用图像处理器将 Buffer 转换为 RGBA8 格式。
  * WindowsApp 更新 SDL 纹理并通过 ImGui 绘制 UI。
* **性能特性**: 支持多线程渲染与 SIMD 指令集优化（SSE2/AVX2）；提供 CPU耗时、纹理上传耗时、最终渲染耗时的实时监控与 FPS 统计。
*  支持 PPM, PNG, BMP, JPG 格式保存。

---

## 核心架构与数据流

### UI 与主循环

* **主入口**: 由应用层驱动。负责初始化（加载场景与 UI 默认值）、处理主循环事件、控制渲染状态、定时更新显示与 UI 绘制。
* **控制面板**: 包含场景选择、相机参数调整、分辨率/宽高比设置、采样率(SPP)/最大深度、积分器选择、色调映射/Gamma/后处理滤镜配置、以及生命周期控制（启动/暂停/停止/保存）。
* **纹理刷新节流**: 默认采用 30 FPS 的贴图更新间隔 (`kTextureUpdateInterval = 1/30s`)，以减少 CPU 到 GPU 的上传开销。

### 渲染生命周期

1. **Start**: 创建 `RenderBuffer`，配置 Renderer（samples, depth, integrator），启动渲染线程。
2. **Pause**: 切换状态并调用 Renderer 的 `cancel`，等待线程停止。
3. **Resume**: 恢复状态为 Rendering，使用当前配置重新启动渲染线程。
4. **Stop**: 请求停止，`join` 等待渲染线程结束，状态回归 Idle。
5. **进度反馈**: UI 实时显示当前渲染进度及剩余时间估算 (ETA)。

### 图像处理管线

* **输入**: `RenderBuffer` (浮点 RGB 数据)。
* **处理步骤**:
  1. **Tone mapping**: 支持 None, Reinhard, ACES。
  2. **Gamma 校正**: LUT 查表法（可变 gamma，默认 LUT 大小 4096）。
  3. **格式转换**: 转换为 RGBA8（包含 SIMD 优化，SSE2/AVX2 路径）。
  4. **后处理 (Post-process)**: 可选模糊、锐化、灰度、反色、中值滤波、双边滤波。
* **输出**: 线性内存中的 RGBA8 数据 (`width × height × 4`)。

### 显示与 UI 渲染

* `WindowsApp` 持有 `SDL_Window`, `SDL_Renderer`, `SDL_Texture`。
* **每帧流程**: ImGui NewFrame → 清屏 → 绘制背景 SDL 纹理 → 绘制 ImGui UI → Present。
* **性能采集**: 记录 Upload 和 Render 两类耗时，结合 Application 记录的图像处理耗时，由 `PerformanceMonitor` 汇总。

---

## 重要模块职责

### Windows 窗口与渲染后端

* 初始化 SDL/ImGui 环境，管理 Renderer 与 Texture 对象。
* 处理系统事件（Quit, Close, ImGui 输入）及帧渲染循环。
* 处理纹理重建与窗口尺寸变更适配。
* 采集底层的上传与最终渲染耗时。

### Application 应用层

* 管理所有 UI 状态（场景 ID、分辨率、相机参数、渲染质量、积分器类型、后处理参数）。
* 统一管理渲染生命周期：`start`, `pause`, `resume`, `stop`。
* 配置覆盖: 渲染进行中强制屏蔽后处理滤镜以提高吞吐；空闲时恢复 UI 配置。

### RenderManager 渲染管理器

* 持有渲染线程句柄与状态机（Idle/Rendering/Paused/Stopping）。
* 负责创建与清空 `RenderBuffer`，驱动 Renderer 执行渲染任务。
* 通过 `cancel` 标志位与线程重启实现暂停/恢复功能。
* 回调机制: 渲染完成时触发 Application 的回调，用于日志记录与状态更新。

### ImageProcessor 图像处理器

* 管理 Tone map、Gamma、后处理开关与类型配置。
* **并行处理**: 按行拆分任务，使用 `std::async` 多线程执行，避免阻塞 UI 主线程。
* **SIMD 优化**:
    * **AVX2**: Reinhard/ACES tone map, Gamma LUT gather, RGBA pack/shuffle/store。
    * **SSE2**: Reinhard/ACES tone map, sqrt 近似 gamma, RGBA pack/unpack/store。


### Utils 图像操作工具

* 实现 Tone map (ACESFilm) 与图像保存 (stb_image_write)。
* **滤镜高性能实现**:
    * **模糊/锐化**: 中心区域快速路径 + 边缘安全路径；权重预乘优化。
    * **中值滤波**: SSE2/AVX2 排序网络，每 4/8 像素并行处理；边界走慢路径。
    * **双边滤波**: 预计算空间/颜色权重查表，窗口半径 2 (5x5)，OpenMP 并行。
* **Gamma LUT**: 预计算查表法避免重复 `pow` 开销。

### PerformanceMonitor 性能监控

* 使用固定窗口大小汇总指标（CPU/GPU upload/UI render/FPS）。
* 计算均值并周期性（默认 1秒）输出到控制台。

---

## UI 说明与交互逻辑

* **场景选择**:
  * 基于 `kSceneNames` 与 `kSceneIds` 映射。
  * 切换场景时，自动调用 `reset_ui_from_scene_config` 重置 UI 参数（FOV、光圈、焦距、SPP、宽高比）
* **相机与分辨率**:
  * 支持 FOV, Aperture, FocusDist 实时调整。
  * 输出尺寸计算：`image_width × aspect_h / aspect_w`。
  * 最小宽度 `kMinImageWidth = 64`，宽高比下限为 1。
* **质量与积分器**:
  * SPP 与 Max Depth 设置。
  * 积分器切换：Path, RR Path, PBR Path, MIS Path, Direct Light。
* **后处理与色调映射**:
  * Tone mapping: None/Reinhard/ACES。
  * Gamma: 0.1–5.0 滑动条，变更时触发 LUT 重建。
  * 滤镜: 提供多种类型，UI 勾选即时生效（非渲染状态下）。
* **渲染控制**:
  * Start/Pause/Resume/Stop 按钮组，状态互斥。
  * 渲染中显示：帧时 (ms/frame), FPS, 进度条, ETA。
* **保存**:
  * 支持 PPM/PNG/BMP/JPG

---

## 性能策略与实现细节

1. **显示节流**: 仅在 `is_rendering` 且距离上次更新超过 `kTextureUpdateInterval` 时才更新纹理；渲染完成或暂停时强制刷新。
2. **后处理自动屏蔽**: 渲染过程中 CPU 端临时关闭滤镜计算，结束或暂停时自动恢复，优先保证渲染线程性能。
3. **多线程任务划分**: 图像处理按行分片，线程数设为 `hardware_concurrency - 1`，使用 `std::async`。
4. **SIMD 细节**:
   * Tone map: 提供 Reinhard/ACES 的 SIMD 实现。
   * Gamma: AVX2 使用 LUT gather 指令；SSE2 使用 sqrt 近似（针对 Gamma=2.0 的简化路径）。
   * RGBA 打包: AVX2 使用 pack + shuffle；SSE2 使用 pack + unpack + scalar store。
5. **贴图上传优化**: 使用 `SDL_LockTexture` 进行行拷贝（考虑 pitch 对齐），记录 `upload_ms`。

---

## TODO

1. ***引入GPU加速，构建sharder进一步加速***
2. 引入更强大的异步日志系统，分级"INFO" "WARN"等
3. 拓展更多性能监控的功能
4. GUI中更多设置

---

## 工程依赖

* **SDL2**: 窗口系统、渲染后端、纹理管理、事件处理。
* **ImGui**: UI 框架 (SDL2 + SDL_Renderer2 backend)。
* **stb_image_write**: 图像编码与保存 (PNG/BMP/JPG)。
* **OpenMP** (可选): 用于部分滤镜的并行加速。**推荐使用！！！**
